resources:
  jobs:
    load_openaq_iterative:
      name: Ingest newest OpenAQ air polution data

      description: Download newest data from OpenAQ API, ingest and dedup the data
      max_concurrent_runs: 1
      parameters:
        - name: catalog
          default: ${var.catalog}
        - name: schema
          default: 02_silver
        - name: city
          default: Belgrade
        
      schedule:
        pause_status: PAUSED
        quartz_cron_expression: "00 00 23 * * ? *"
        timezone_id: "CET"
      tasks:
        - task_key: find_last_ingested_date_by_location_sensor
          sql_task:
            file:
              path: ../sql/find_last_ingested_date_by_location_sensor.sql
            warehouse_id: ${var.warehouse_id}
        - task_key: foreach_location
          depends_on:
          - task_key: find_last_ingested_date_by_location_sensor
          for_each_task:
            inputs: "{{tasks.find_last_ingested_date_by_location_sensor.output.rows}}"
            task:
              task_key: run_measurements_load_script
              environment_key: default
              max_retries: 3
              min_retry_interval_millis: 60000
              run_if: ALL_SUCCESS
              spark_python_task:
                parameters:
                  - "--mode=measurements"
                  - "--location_id"
                  - "{{input.id}}"
                  - "--location_name"
                  - "{{input.name}}"
                  - "--sensors"
                  - "{{input.sensor_id_arr}}"
                  - "--date_from"
                  - "{{input.last_date}}"
                  - "--datastore_path"
                  - "/Volumes/air_polution_analytics_dev/00_landing/openaq/measurements/"
                python_file: ../src/download_openaq_polution_data.py
        - task_key: run_measurements_etl_pipeline_and_dedup
          run_job_task:
            job_id: ${resources.jobs.ingest_and_dedup_openaq_data.id}
          depends_on:
          - task_key: foreach_location
          run_if: ALL_SUCCESS
      environments:
        - environment_key: default
          spec:
            dependencies:
              - openaq
            environment_version: "4"